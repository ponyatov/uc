% ebook header
\documentclass[oneside,10pt]{article}
\usepackage[paperwidth=118.8mm,paperheight=68.2mm,margin=2mm]{geometry}
\renewcommand{\familydefault}{\sfdefault}\normalfont
\usepackage[unicode,colorlinks=true]{hyperref}
\usepackage[pdftex]{graphicx}
\newcommand{\fig}[3]{\noindent\includegraphics[#3]{#2}\\\textbf{#1}}
\usepackage{enumitem}
%% Cyrillization
\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}
% xcolor fixes
\usepackage{xcolor}
\definecolor{red}{rgb}{0.7,0,0}		% R
\definecolor{green}{rgb}{0,0.6,0}	% G
\definecolor{blue}{rgb}{0,0,0.7}	% B
%% misc
\renewcommand{\emph}[1]{\textcolor{blue}{#1}}
\newcommand{\note}[1]{\,\footnote{\ #1}}
\newcommand{\email}[1]{$<$\href{mailto:#1}{#1}$>$}
\newcommand{\term}[1]{\textcolor{green}{#1}}
\newcommand{\error}[1]{\textcolor{red}{#1}}
%% lang
\newcommand{\cpp}{$C^+_+$}
\newcommand{\py}{$Python$}
%% prog
\newcommand{\prog}[1]{\textbf{#1}}
\newcommand{\file}[1]{\textit{#1}}
\newcommand{\make}{\prog{make}}
\newcommand{\git}{\prog{git}}
\newcommand{\gvim}{\prog{(g)Vim}}
\newcommand{\flex}{\prog{flex}}
\newcommand{\lex}{\prog{lex}}
\newcommand{\yacc}{\prog{yacc}}
\newcommand{\bison}{\prog{bison}}
\newcommand{\gpp}{\prog{g++}}
\newcommand{\eclipse}{\prog{eclipse}}
%% listings
\usepackage{listings}
\lstset{
basicstyle=\small,
frame=single,
tabsize=4,
}
\newcommand{\lst}[2]{\lstinputlisting[title=#1]{#2}}

\title{$\mu$Compiler: микрокомпилятор}
\author{\copyright\ Dmitry Ponyatov \email{dponyatov@gmail.com}}

\begin{document}
\maketitle
\begin{abstract}
Рассмотрена реализация компилятора для простейшего арифметического языка на
\flex/\bison/\cpp.
\end{abstract}
\clearpage\tableofcontents\clearpage

\section{Необходимое программное обеспечение}

\begin{itemize}
  \item пакет {mingw}\note{\url{http://www.mingw.org/}}: нужны пакеты
  \gpp\ \make\ \flex\ \bison
  \item рекомендуется текстовый редактор
  \gvim\note{\url{http://vim.sourceforge.net/download.php\#pc}}
\end{itemize}

\section{Структура проекта (lexical skeleton)}

\begin{tabular}{l l l}
src.src & script & тестовый скрипт на нашем языке \\
log.log & & лог выполнения компилятора \\
ypp.ypp & \yacc & описание синтаксиса (грамматика) \\
lpp.lpp & \lex & регулярные выражения для лексем \\
hpp.hpp & \cpp & общие хедеры \\
cpp.cpp & \cpp & \\
.gitignore & \git & маски файлов не включаемых в проект \\
bat.bat & \gvim & helper для запуска редактора \\
Makefile & \make & скрипт сборки проекта \\
\end{tabular}

\lst{\file{core.src}: ядро компилятора}{doc/core.src}
% \lst{\file{files.src}: файлы проекта}{doc/files.src}

\fig{файлы типового проекта лексической
программы}{files.pdf}{width=\textwidth}

\subsection{Структура типичного компилятора}

\fig{}{compiler.pdf}{height=0.6\textheight}

\subsection{Сборка проекта утилитой [mingw32-]\make}

\lst{Makefile}{doc/00.mk}

\section{Лексер}

\term{Лексический анализ}\ --- группировка единичных символов входного потока
(исходного кода) в токены. \term{Токен} можно рассматривать как пару из двух
элементов:
\begin{description}[nosep]
\item[тэг]\ \\маркер типа токена: идентификатор, число, оператор,\ldots
\item[\term{лексема}]\ \\текстовое значение токена, полученное группировкой
  нескольких символов 
\end{description}

\bigskip
В нашем компиляторе будем использовать генератор лексеров\ --- программу \flex.

\subsection{Тестовый файл \#00}

Рассмотрим разбор следующего тестового файла:
\lst{\file{src.src}: тест \#00}{doc/00.src}

\clearpage
Как мы видим он состоит из следующих элементов:
\begin{itemize}[nosep]
  \item \# комментарий
  \item выражение с присвоением переменной
  \item \term{директива} \verb|.end|
  \item некая ахинея похожая на список файлов проекта\note{возможно когда-нибудь
  наш компилятор сможет сгененировать собственный исходник из высокоуровневого
  описания}
\end{itemize}

\bigskip
Измените \file{Makefile} чтобы при сборке проекта использовался только лексер:
\lst{\file{Makefile}: изоляция лексера}{doc/01.mk}

\subsection{Структура файла лексера}

\begin{verbatim}
%{
С(++) код включаемый в начало сгенерированного lex.yy.c
%}

%option ... /* опции */

%%
набор пар
<регулярное выражение>:<С(++) действие над выделенной лексемой> 
%%

любой дополнительный С(++) код, например int main()
\end{verbatim}

\lst{\file{lpp.lpp}: пустой лексер}{doc/00.lpp}
транслируется командой \verb|mingw32-make| в \file{lex.yy.c}, но
\lst{\file{log.log}: ошибки}{doc/00.llg}

\clearpage
добавим пару опций
\lst{\file{lpp.lpp}: пустой лексер}{doc/01.lpp}
\lst{\file{log.log}: bypass исходного кода}{doc/01.llg}

Все нераспознанные лексером символы входного потока по умолчанию копируются в
выходной без изменений. Неплохо, но тот же результат проще получить командой
копирования.

\bigskip
Добавим несколько регулярных выражений, которые
\begin{itemize}
  \item удалят все комментарии
  \item удалят все пробельные символы\note{обычно в языках программирования они
  имеют только фунцию улучшения читаемости, но не забываем про \py} и
  \item остановят разбор по директиве \verb|.end|
\end{itemize}

\noindent
Не забудьте про обязательный символ конца последней строки\ --- редактируя
\file{lpp.lpp} в \eclipse\ я получил ошибку \error{lpp.lpp:5: EOF encountered
inside an action}

\lst{\file{lpp.lpp}: удаление лишнего}{doc/02.lpp}
\lst{\file{log.log}: остались только значащие символы}{doc/02.llg}

\subsection{\term{regexp}: регулярные выражения}

\begin{tabular}{l l}
\verb|.| & любой символ кроме \verb|\n| \\
\verb|\n| & конец строки \\
\verb|\r| & огрызок Micro\$oft \\
\verb|\t| & табуляция \\
\verb|(...)| & группа \\
\verb|()?| & необязательное вхождение \\
\verb|()*| & \emph{0}+ повторений \\
\verb|()+| & \emph{1}+ повторений \\
\verb|[...]| & один из символов набора \ldots \\
\verb|[^...]| & любой символ \emph{кроме} \ldots \\
\verb|{x}| & подстановка макрорегулярки определенной отдельно \\
\end{tabular}

\subsection{Лексемы тестового примера}

И наконец выделим числа, операторы и переменные:

\lst{\file{lpp.lpp}: полный набор \term{regexp}ов}{doc/03.lpp}
\lst{\file{lpp.lpp}: числа (несколько вариантов)}{doc/04.lpp}
пришлось перенести, в файле должны быть в одну строку
\lst{\file{log.log}: числа}{doc/04.llg}
\clearpage
\lst{\file{lpp.lpp}: имена и операторы}{doc/05.lpp}
\clearpage
\lst{\file{log.log}: имена и операторы}{doc/05.llg}

\end{document}
